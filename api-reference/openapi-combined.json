{
  "openapi": "3.0.0",
  "info": {
    "title": "Tu Pana API",
    "description": "API para integración con el sistema Tu Pana - Facturación Electrónica",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "https://api.tupana.ai/v1",
      "description": "Servidor de producción"
    }
  ],
  "security": [
    {
      "apiKeyAuth": []
    }
  ],
  "paths": {
    "/documents": {
      "get": {
        "operationId": "listDocuments",
        "tags": [
          "Documentos"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Listar documentos",
        "description": "Obtiene las listas de documentos emitidos o recibidos por una entidad específica. Soporta búsqueda por folio, nombre del receptor y filtros avanzados.",
        "parameters": [
          {
            "name": "master_entity_id",
            "in": "query",
            "description": "ID de la entidad emisora o receptora cuyos documentos quieres consultar.",
            "required": true,
            "schema": {
              "type": "integer"
            }
          },
          {
            "name": "document_type",
            "in": "query",
            "description": "`issued` (por defecto) o `received`. `issued` devuelve documentos donde la entidad es el **emisor**. `received` devuelve documentos donde la entidad es el **receptor** (cuando usas `received`, el parámetro `search` buscará en el nombre y RUT del emisor, y `issuer_tax_id` permite filtrar por RUT del emisor específico).",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "issued",
                "received"
              ],
              "default": "issued"
            }
          },
          {
            "name": "folio",
            "in": "query",
            "description": "Folio exacto del documento. Si se envía, se ignoran otros filtros y se devuelve el documento específico.",
            "required": false,
            "schema": {
              "type": "integer"
            }
          },
          {
            "name": "search",
            "in": "query",
            "description": "Busca por nombre o RUT del receptor (cuando `document_type=issued`) o del emisor (cuando `document_type=received`).",
            "required": false,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "dte_type__code__in",
            "in": "query",
            "description": "Lista de códigos DTE separados por coma (ej: `33,34`).",
            "required": false,
            "style": "form",
            "explode": false,
            "schema": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "default": [
                "33",
                "34",
                "39",
                "61"
              ]
            }
          },
          {
            "name": "issuer_tax_id",
            "in": "query",
            "description": "RUT del emisor cuando `document_type=received`.",
            "required": false,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "page",
            "in": "query",
            "description": "Página actual, parte de la paginación estándar. Por defecto: 1. La respuesta incluye `count` (total), `next`, `previous` (URLs de navegación) y `results` (arreglo de documentos con información de emisor, receptor, montos, estado, PDF y referencias).",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 1
            }
          },
          {
            "name": "page_size",
            "in": "query",
            "description": "Tamaño de página (máx. 100). Por defecto: 20.",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 20,
              "maximum": 100
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de documentos obtenida exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DocumentListResponse"
                }
              }
            }
          },
          "403": {
            "description": "Sin permisos para acceder a esta entidad",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Entidad no encontrada",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/documents/batch": {
      "post": {
        "operationId": "createDocumentsBatch",
        "summary": "Envío de documentos en lote",
        "description": "Crea hasta 200 documentos en una sola llamada. La respuesta incluye información completa de cada documento creado, incluyendo PDF cuando está disponible. Los resultados también se enviarán por webhook si está configurado.\n\n**Permisos requeridos:** La API Key debe tener el permiso `document:create` o permisos completos (`*`). Además, la entidad emisora debe tener credenciales SII válidas configuradas.",
        "parameters": [
          {
            "name": "Idempotency-Key",
            "in": "header",
            "description": "Previene lotes duplicados (≤ 256 caracteres, expira después de 24 h)",
            "required": false,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "X-Use-Defaults",
            "in": "header",
            "description": "Si se establece como true, el sistema usará valores por defecto para campos no proporcionados:\n- Fecha actual para date_issued\n- Datos del emisor según configuración de la plataforma o primera actividad/dirección disponible\n- Datos del receptor según configuración del cliente o primera actividad/dirección disponible\n- Payment method = '2' (crédito) en el header del documento",
            "required": false,
            "schema": {
              "type": "boolean",
              "default": false
            }
          }
        ],
        "requestBody": {
          "description": "Lote de documentos a crear",
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/DocumentBatch"
              },
              "example": {
                "documents": [
                  {
                    "dte_type": {
                      "code": "33"
                    },
                    "date_issued": "2024-01-15",
                    "document_issuer": {
                      "rut": "12345678-9",
                      "business_name": "Mi Empresa SpA"
                    },
                    "document_receiver": {
                      "rut": "98765432-1",
                      "business_name": "Cliente Importante Ltda"
                    },
                    "details": [
                      {
                        "item_name": "Servicio de Consultoría",
                        "quantity": 1,
                        "unit_price": 100000,
                        "item_total": 100000
                      }
                    ]
                  }
                ]
              }
            }
          },
          "required": true
        },
        "responses": {
          "202": {
            "description": "Solicitud de creación de documentos aceptada. Los resultados se enviarán por webhook.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BatchResponse"
                },
                "example": {
                  "batch_id": "550e8400-e29b-41d4-a716-446655440000",
                  "status": "processing",
                  "created_at": "2024-01-15T10:30:00Z",
                  "documents": [
                    {
                      "index": 0,
                      "status": "created",
                      "document": {
                        "id": 12345,
                        "folio": "1",
                        "date_issued": "2024-01-15",
                        "amount_with_iva": 119000.0,
                        "receiver_id": 456,
                        "is_draft": false,
                        "can_be_issued": true,
                        "dte_type": {
                          "code": "33",
                          "description": "Factura Electrónica"
                        },
                        "sender": {
                          "id": 123,
                          "name": "Mi Empresa SpA",
                          "tax_id": "12345678-9"
                        },
                        "receiver": {
                          "id": 456,
                          "name": "Cliente Importante Ltda",
                          "tax_id": "98765432-1"
                        },
                        "items": [
                          {
                            "item_name": "Servicio de Consultoría",
                            "item_description": null,
                            "quantity": 1.0,
                            "unit_price": 100000.0,
                            "item_total": 100000.0,
                            "unit": "UN",
                            "item_code": null,
                            "item_type_code": null,
                            "discount_percent": null,
                            "other_tax": null
                          }
                        ],
                        "document_total": {
                          "net_amount": 100000.0,
                          "iva_rate": 19.0,
                          "iva_amount": 19000.0,
                          "total_amount": 119000.0
                        },
                        "pdf_url": "https://s3.amazonaws.com/bucket/documento_12345.pdf?signature=...",
                        "pdf_download_url": "/api/master-entities/123/documents/12345/file/"
                      }
                    }
                  ]
                }
              }
            }
          },
          "403": {
            "description": "Sin permisos para crear documentos. La API Key debe tener el permiso 'document:create' o permisos completos ('*'). Además, la entidad emisora debe tener credenciales SII válidas configuradas.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "example": {
                  "error": "Esta entidad no tiene credenciales SII válidas configuradas"
                }
              }
            }
          },
          "413": {
            "description": "Más de 200 documentos en el array",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "422": {
            "description": "Cuerpo malformado o fallo de validación",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          }
        ]
      }
    },
    "/documents/{document_id}": {
      "get": {
        "operationId": "getDocument",
        "tags": [
          "Documentos"
        ],
        "summary": "Obtener documento específico",
        "description": "Obtiene toda la información completa de un documento tributario específico, incluyendo:\n\n- **PDF y XML** cuando están disponibles (el PDF siempre se incluye en la respuesta, campo `pdf_url`)\n- **Detalles (productos/líneas)** del documento (campo `details`)\n- **Header completo** con información de transacción, pago y tipo de compra (campo `header`)\n- **Información del emisor** completa (campo `document_issuer`)\n- **Información del receptor** completa (campo `document_receiver`)\n- **Referencias** a otros documentos, como notas de crédito (campo `references`)\n\nEste endpoint es útil para consultar detalles completos de un documento ya emitido o recibido.\n\n**Seguridad:** El usuario solo puede acceder al documento si es emisor (sender) o receptor (receiver) del documento. Si el usuario no tiene acceso, se retorna un error 403 Forbidden.",
        "parameters": [
          {
            "name": "document_id",
            "in": "path",
            "description": "ID único del documento a consultar (entero)",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Documento obtenido exitosamente con toda la información completa: PDF, XML, detalles (productos), header, información del emisor y receptor, y referencias",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DocumentDetailWithFiles"
                }
              }
            }
          },
          "400": {
            "description": "Parámetros inválidos",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "API Key faltante o inválida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Sin permisos para acceder al documento. El usuario debe ser emisor (sender) o receptor (receiver) del documento.",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "No tienes acceso a este documento"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Documento o entidad no encontrada",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          }
        ]
      }
    },
    "/credentials": {
      "get": {
        "operationId": "listCredentials",
        "tags": [
          "Credenciales"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Listar credenciales",
        "description": "Obtiene todas las activas del usuario autenticado",
        "responses": {
          "200": {
            "description": "Lista de credenciales obtenida exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "id": {
                        "type": "integer",
                        "description": "ID único de la credencial",
                        "example": 245
                      },
                      "user": {
                        "type": "string",
                        "description": "RUT del usuario de la credencial",
                        "example": "16659618-1"
                      },
                      "credential_type": {
                        "type": "object",
                        "description": "Tipo de credencial",
                        "properties": {
                          "id": {
                            "type": "integer",
                            "description": "ID del tipo de credencial",
                            "example": 70
                          },
                          "name": {
                            "type": "string",
                            "description": "Nombre del tipo de credencial",
                            "example": "SII"
                          }
                        }
                      },
                      "created_at": {
                        "type": "string",
                        "format": "date-time",
                        "description": "Fecha de creación de la credencial",
                        "example": "2025-08-06T01:24:45.422918Z"
                      },
                      "status": {
                        "type": "string",
                        "description": "Estado de la credencial",
                        "enum": [
                          "VALID",
                          "INVALID",
                          "EXPIRED"
                        ],
                        "example": "VALID"
                      },
                      "master_entities": {
                        "type": "array",
                        "description": "Lista de entidades maestras asociadas a la credencial",
                        "items": {
                          "type": "object",
                          "properties": {
                            "id": {
                              "type": "integer",
                              "description": "ID de la entidad maestra",
                              "example": 4355
                            },
                            "name": {
                              "type": "string",
                              "description": "Nombre de la entidad maestra",
                              "example": "HIDDEN CORE SPA"
                            },
                            "tax_id": {
                              "type": "string",
                              "description": "RUT de la entidad maestra",
                              "example": "78.121.555-4"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "No autorizado - API key inválida o faltante",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Prohibido - Sin permisos para acceder a credenciales",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      },
      "post": {
        "operationId": "createCredential",
        "summary": "Crear credencial",
        "description": "Crea una nueva credencial validándola en el SII",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "user_rut",
                  "password",
                  "digital_certificate_password",
                  "master_entity_id"
                ],
                "properties": {
                  "user_rut": {
                    "type": "string",
                    "description": "RUT del usuario (sin puntos y con guión)",
                    "pattern": "^[0-9]+-[0-9kK]$",
                    "example": "12345678-9"
                  },
                  "password": {
                    "type": "string",
                    "description": "Contraseña del usuario en el SII",
                    "example": "mi_password_segura"
                  },
                  "digital_certificate_password": {
                    "type": "string",
                    "description": "Contraseña del certificado digital",
                    "example": "mi_password_certificado"
                  },
                  "master_entity_id": {
                    "type": "integer",
                    "description": "ID de la entidad maestra a la que pertenece la credencial",
                    "example": 123
                  },
                  "credential_type_id": {
                    "type": "integer",
                    "description": "ID del tipo de credencial (opcional, por defecto SII)",
                    "example": 70
                  }
                }
              },
              "example": {
                "user_rut": "12345678-9",
                "password": "mi_password_segura",
                "digital_certificate_password": "mi_password_certificado",
                "master_entity_id": 123
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Credencial creada exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "integer",
                      "description": "ID único de la credencial creada",
                      "example": 1
                    },
                    "user": {
                      "type": "string",
                      "description": "RUT del usuario de la credencial",
                      "example": "12345678-9"
                    },
                    "master_entity": {
                      "type": "object",
                      "description": "Información de la entidad maestra asociada",
                      "properties": {
                        "id": {
                          "type": "integer",
                          "description": "ID de la entidad maestra",
                          "example": 123
                        },
                        "name": {
                          "type": "string",
                          "description": "Nombre de la entidad maestra",
                          "example": "Empresa Ejemplo SpA"
                        },
                        "tax_id": {
                          "type": "string",
                          "description": "RUT de la entidad maestra",
                          "example": "76543210-1"
                        }
                      }
                    },
                    "credential_type": {
                      "type": "object",
                      "description": "Tipo de credencial",
                      "properties": {
                        "id": {
                          "type": "integer",
                          "description": "ID del tipo de credencial",
                          "example": 70
                        },
                        "name": {
                          "type": "string",
                          "description": "Nombre del tipo de credencial",
                          "example": "SII"
                        }
                      }
                    },
                    "status": {
                      "type": "string",
                      "description": "Estado de la credencial",
                      "enum": [
                        "VALID",
                        "INVALID",
                        "EXPIRED"
                      ],
                      "example": "VALID"
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Fecha de creación de la credencial",
                      "example": "2024-01-01T10:00:00Z"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Error en la validación de datos",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "No autorizado - API key inválida o faltante",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Prohibido - Sin permisos para crear credenciales",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Entidad maestra no encontrada",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "422": {
            "description": "Error de validación en el SII",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          }
        ]
      }
    },
    "/master-entities": {
      "get": {
        "summary": "Buscar entidad por RUT",
        "description": "Busca una entidad maestra específica por su RUT. Requiere autenticación por API Key.\n\n**Permisos requeridos:** Este endpoint actualmente no requiere permisos específicos (`AllowAny`), pero requiere autenticación válida por API Key.\n\n**Respuesta:** Retorna información completa de la entidad incluyendo direcciones y actividades económicas. Si la entidad no existe en la base de datos, el sistema intentará buscarla y crearla automáticamente usando el scraper del SII.",
        "parameters": [
          {
            "name": "rut",
            "in": "query",
            "description": "RUT del cliente a consultar (formato: 76543210-1, sin puntos)",
            "required": true,
            "schema": {
              "type": "string",
              "pattern": "^[0-9]{7,8}-[0-9K]$",
              "example": "76543210-1"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Entidad encontrada exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MasterEntity"
                },
                "example": {
                  "id": 371,
                  "tax_id": "76.798.398-0",
                  "name": "SUPLO SPA",
                  "email": "contacto@suplo.cl",
                  "addresses": [
                    {
                      "id": 6,
                      "address": "AV TAJAMAR 183 OF 401   OFIC",
                      "district": {
                        "id": 7,
                        "name": "LAS CONDES",
                        "city": {
                          "id": 3,
                          "name": "SANTIAGO"
                        }
                      },
                      "sii_branch_code": null,
                      "phone": null
                    }
                  ],
                  "activities": [
                    {
                      "id": 1,
                      "code": "620900",
                      "name": "OTRAS ACTIVIDADES DE TECNOLOGIA DE LA IN"
                    }
                  ]
                }
              }
            }
          },
          "403": {
            "description": "API Key inválida o sin autenticación. Aunque este endpoint no requiere permisos específicos, requiere una API Key válida.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "example": {
                  "error": "API Key inválida o faltante"
                }
              }
            }
          },
          "400": {
            "description": "Parámetro 'rut' faltante o formato inválido",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "API Key inválida o faltante",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Entidad no encontrada",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          }
        ]
      }
    },
    "/scheduled-documents": {
      "get": {
        "tags": [
          "Documentos Programados"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Listar documentos programados",
        "description": "Obtiene una lista paginada de documentos programados de una entidad específica. Los documentos programados son plantillas que se ejecutan automáticamente según una frecuencia definida.",
        "parameters": [
          {
            "name": "master_entity_id",
            "in": "query",
            "description": "ID de la entidad maestra",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 123
            }
          },
          {
            "name": "status",
            "in": "query",
            "description": "Filtrar por estado del documento programado",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "active",
                "inactive",
                "completed"
              ],
              "example": "active"
            }
          },
          {
            "name": "frequency",
            "in": "query",
            "description": "Filtrar por frecuencia de ejecución",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "daily",
                "weekly",
                "monthly",
                "quarterly"
              ],
              "example": "monthly"
            }
          },
          {
            "name": "dte_type",
            "in": "query",
            "description": "Filtrar por tipo de DTE",
            "required": false,
            "schema": {
              "type": "string",
              "example": "33"
            }
          },
          {
            "name": "page",
            "in": "query",
            "description": "Número de página para paginación",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 1,
              "example": 1
            }
          },
          {
            "name": "page_size",
            "in": "query",
            "description": "Número de elementos por página",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 20,
              "maximum": 100,
              "example": 20
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de documentos programados obtenida exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ScheduledDocumentListResponse"
                }
              }
            }
          },
          "400": {
            "description": "Parámetros inválidos",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "No autorizado - API Key inválida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Prohibido - Sin acceso a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      },
      "post": {
        "operationId": "createScheduledDocument",
        "tags": [
          "Documentos Programados"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Crear documento programado",
        "description": "Crea un nuevo documento programado que se ejecutará automáticamente según la frecuencia especificada.",
        "requestBody": {
          "description": "Datos del documento programado a crear",
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ScheduledDocumentCreate"
              },
              "example": {
                "sender": 123,
                "dte_type": "33",
                "receiver_tax_id": "76111111-1",
                "frequency": "monthly",
                "day_of_month": 10,
                "currency": "CLP",
                "currency_day": 10,
                "status": "active",
                "references": [
                  {
                    "dte_type_code": "33",
                    "reference_folio": "100",
                    "reference_date": "2024-01-15",
                    "reference_reason": "ANULA DOCUMENTO DE LA REFERENCIA"
                  }
                ],
                "details": [
                  {
                    "item_name": "Servicio mensual de consultoría",
                    "item_description": "Asistencia contable mensual",
                    "quantity": 1,
                    "unit_price": 150000
                  }
                ]
              }
            }
          },
          "required": true
        },
        "responses": {
          "201": {
            "description": "Documento programado creado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ScheduledDocument"
                },
                "example": {
                  "id": 987,
                  "sender": {
                    "id": 123,
                    "name": "Empresa Ejemplo SpA",
                    "rut": "76543210-1"
                  },
                  "receiver": {
                    "id": 456,
                    "name": "Cliente ABC Ltda",
                    "rut": "12345678-9"
                  },
                  "dte_type": {
                    "id": 1,
                    "code": "33",
                    "description": "Factura Electrónica"
                  },
                  "frequency": "monthly",
                  "frequency_display": "Mensual",
                  "day_of_month": 10,
                  "day_of_week": null,
                  "next_execution": "2024-03-10T10:00:00Z",
                  "status": "active",
                  "status_display": "Activo",
                  "amount": 150000,
                  "currency": "CLP",
                  "currency_day": 10,
                  "completed_occurrences": 0,
                  "max_occurrences": null,
                  "references": [
                    {
                      "id": 1,
                      "dte_type_code": "33",
                      "reference_folio": "100",
                      "reference_date": "2024-01-15",
                      "reference_reason": "ANULA DOCUMENTO DE LA REFERENCIA"
                    }
                  ],
                  "details": [
                    {
                      "id": 1,
                      "item_name": "Servicio mensual de consultoría",
                      "item_description": "Asistencia contable mensual",
                      "quantity": 1,
                      "unit_price": 150000,
                      "item_total": 150000
                    }
                  ],
                  "created_at": "2024-02-05T12:15:00Z",
                  "updated_at": "2024-02-05T12:15:00Z"
                }
              }
            }
          },
          "400": {
            "description": "Datos inválidos",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "No autorizado - API Key inválida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Prohibido - Sin acceso a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "422": {
            "description": "Error de validación en el SII",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/scheduled-documents/{id}": {
      "get": {
        "tags": [
          "Documentos Programados"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Obtener documento programado",
        "description": "Obtiene los detalles de un documento programado específico.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "ID del documento programado",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 789
            }
          },
          {
            "name": "master_entity_id",
            "in": "query",
            "description": "ID de la entidad maestra",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 123
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Documento programado obtenido exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ScheduledDocument"
                }
              }
            }
          },
          "404": {
            "description": "Documento programado no encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "No autorizado - API Key inválida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Prohibido - Sin acceso a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      },
      "patch": {
        "operationId": "updateScheduledDocument",
        "tags": [
          "Documentos Programados"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Actualizar documento programado",
        "description": "Actualiza parcialmente un documento programado existente.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "ID del documento programado",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 789
            }
          },
          {
            "name": "master_entity_id",
            "in": "query",
            "description": "ID de la entidad maestra",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 123
            }
          }
        ],
        "requestBody": {
          "description": "Campos a actualizar del documento programado",
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ScheduledDocumentUpdate"
              },
              "example": {
                "status": "inactive",
                "amount": 120000,
                "currency_day": 15,
                "references": [
                  {
                    "dte_type_code": "33",
                    "reference_folio": "100",
                    "reference_date": "2024-01-15",
                    "reference_reason": "ANULA DOCUMENTO DE LA REFERENCIA"
                  }
                ],
                "details": [
                  {
                    "item_name": "Servicio actualizado",
                    "item_description": "Descripción del servicio",
                    "quantity": 1,
                    "unit_price": 120000
                  }
                ]
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Documento programado actualizado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ScheduledDocument"
                }
              }
            }
          },
          "400": {
            "description": "Datos inválidos",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "No autorizado - API Key inválida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Prohibido - Sin acceso a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Documento programado no encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": [
          "Documentos Programados"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Eliminar documento programado",
        "description": "Elimina un documento programado existente.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "ID del documento programado",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 789
            }
          },
          {
            "name": "master_entity_id",
            "in": "query",
            "description": "ID de la entidad maestra",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 123
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Documento programado eliminado exitosamente"
          },
          "404": {
            "description": "Documento programado no encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "No autorizado - API Key inválida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Prohibido - Sin acceso a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/scheduled-documents/{id}/preview": {
      "get": {
        "tags": [
          "Documentos Programados"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Preview de documento programado guardado",
        "description": "Genera un preview en PDF del próximo documento que se emitirá para un documento programado ya guardado.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "ID del documento programado",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 789
            }
          },
          {
            "name": "master_entity_id",
            "in": "query",
            "description": "ID de la entidad maestra",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 123
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Preview generado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "pdf_base64": {
                      "type": "string",
                      "description": "PDF del documento en formato base64",
                      "example": "JVBERi0xLjQKMSAwIG9iago8PC9UeXBlIC9DYXRhbG9n..."
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Documento programado no encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "500": {
            "description": "Error generando el preview",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "No autorizado - API Key inválida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Prohibido - Sin acceso a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/documents/{document_id}/states": {
      "get": {
        "operationId": "listDocumentStates",
        "tags": [
          "Estados de Documentos"
        ],
        "summary": "Consultar historial de estados de un documento",
        "description": "Consultar el historial de estados asociados a un documento tributario específico.",
        "parameters": [
          {
            "name": "document_id",
            "in": "path",
            "description": "ID único del documento (integer)",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Historial de estados obtenido exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DocumentStatesResponse"
                }
              }
            }
          },
          "401": {
            "description": "No autenticado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Sin permisos para acceder a este documento",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "example": {
                  "error": "No tienes acceso a este documento"
                }
              }
            }
          },
          "404": {
            "description": "Documento no encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          }
        ]
      },
      "post": {
        "tags": [
          "Estados de Documentos"
        ],
        "summary": "Registrar nuevo estado en un documento",
        "description": "Registrar un nuevo estado cuando ocurre un evento relevante sobre el documento.",
        "parameters": [
          {
            "name": "document_id",
            "in": "path",
            "description": "ID único del documento (integer)",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/DocumentStateRequest"
              },
              "examples": {
                "acuse_recibo": {
                  "summary": "Registrar acuse de recibo",
                  "value": {
                    "event_code": "ERM"
                  }
                },
                "rechazo": {
                  "summary": "Registrar rechazo",
                  "value": {
                    "event_code": "RCD",
                    "rejection_reason": "Error en el monto facturado"
                  }
                },
                "aceptacion_contenido": {
                  "summary": "Aceptar contenido del documento",
                  "value": {
                    "event_code": "ACD"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Estado registrado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DocumentStateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Parámetros inválidos o error al registrar el evento",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "examples": {
                  "parametros_faltantes": {
                    "value": {
                      "error": "Se requiere el código del evento (event_code)"
                    }
                  },
                  "evento_invalido": {
                    "value": {
                      "error": "Código de evento inválido. Debe ser uno de: ERM, ACD, RCD, RFT, RFP"
                    }
                  },
                  "error_sii": {
                    "value": {
                      "success": false,
                      "error": "Error al registrar evento en el SII",
                      "error_code": "SII_ERROR_CODE"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "No autenticado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Sin permisos para acceder a este documento",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Documento no encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          }
        ]
      }
    },
    "/cessions/batch": {
      "post": {
        "operationId": "createCessionBatch",
        "tags": [
          "Cesiones"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Generar cesiones de facturas en lote",
        "description": "Genera cesiones (AECs) de múltiples facturas en una sola llamada. Obtiene automáticamente los códigos EHDR del SII y envía los AECs al SII.",
        "requestBody": {
          "description": "Datos para generar las cesiones",
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "master_entity_id",
                  "document_ids",
                  "assignee_rut",
                  "assignee_dv",
                  "assignee_business_name",
                  "assignee_address",
                  "assignee_email"
                ],
                "properties": {
                  "master_entity_id": {
                    "type": "integer",
                    "description": "ID de la entidad maestra emisora de las facturas",
                    "example": 123
                  },
                  "document_ids": {
                    "type": "array",
                    "items": {
                      "type": "integer"
                    },
                    "description": "Lista de IDs de los documentos (facturas) a ceder",
                    "example": [
                      858405,
                      858406
                    ]
                  },
                  "assignee_rut": {
                    "type": "string",
                    "description": "RUT del cesionario (sin puntos ni guión)",
                    "example": "76798398"
                  },
                  "assignee_dv": {
                    "type": "string",
                    "description": "Dígito verificador del RUT del cesionario",
                    "example": "0"
                  },
                  "assignee_business_name": {
                    "type": "string",
                    "description": "Razón social del cesionario",
                    "example": "SUPLO SPA"
                  },
                  "assignee_address": {
                    "type": "string",
                    "description": "Dirección del cesionario",
                    "example": "Av. Tajamar 183"
                  },
                  "assignee_email": {
                    "type": "string",
                    "format": "email",
                    "description": "Email del cesionario",
                    "example": "factoring@suplo.cl"
                  },
                  "assignor_email": {
                    "type": "string",
                    "format": "email",
                    "description": "Email del cedente (opcional, se usa el email de la entidad si no se proporciona)",
                    "example": "antonio@tupana.ai"
                  }
                }
              },
              "example": {
                "master_entity_id": 123,
                "document_ids": [
                  858405,
                  858406
                ],
                "assignee_rut": "76798398",
                "assignee_dv": "0",
                "assignee_business_name": "SUPLO SPA",
                "assignee_address": "Av. Tajamar 183",
                "assignee_email": "factoring@suplo.cl",
                "assignor_email": "antonio@tupana.ai"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Cesiones generadas exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "message": {
                      "type": "string",
                      "example": "2 assignment(s) generated successfully"
                    },
                    "cessions": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "cession_id": {
                            "type": "integer",
                            "example": 133
                          },
                          "document_id": {
                            "type": "integer",
                            "example": 858405
                          },
                          "folio": {
                            "type": "integer",
                            "example": 12345
                          },
                          "file_name": {
                            "type": "string",
                            "example": "AEC_12345.xml"
                          },
                          "presigned_url": {
                            "type": "string",
                            "format": "uri",
                            "example": "https://s3.amazonaws.com/..."
                          }
                        }
                      }
                    },
                    "aec_results": {
                      "type": "array",
                      "description": "Resultados del envío de AECs al SII",
                      "items": {
                        "type": "object",
                        "properties": {
                          "folio": {
                            "type": "integer"
                          },
                          "sii_identifier": {
                            "type": "string"
                          },
                          "sii_file_name": {
                            "type": "string"
                          },
                          "status": {
                            "type": "string",
                            "enum": [
                              "sent_to_sii",
                              "failed"
                            ]
                          },
                          "error": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "errors": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "document_id": {
                            "type": "integer"
                          },
                          "folio": {
                            "type": "integer"
                          },
                          "error": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "total_processed": {
                      "type": "integer",
                      "example": 2
                    },
                    "total_errors": {
                      "type": "integer",
                      "example": 0
                    },
                    "aec_sent": {
                      "type": "integer",
                      "description": "Número de AECs enviados exitosamente al SII",
                      "example": 2
                    }
                  }
                },
                "example": {
                  "success": true,
                  "message": "2 assignment(s) generated successfully",
                  "cessions": [
                    {
                      "cession_id": 133,
                      "document_id": 858405,
                      "folio": 12345,
                      "file_name": "AEC_12345.xml",
                      "presigned_url": "https://s3.amazonaws.com/bucket/AEC_12345.xml?signature=..."
                    },
                    {
                      "cession_id": 134,
                      "document_id": 858406,
                      "folio": 12346,
                      "file_name": "AEC_12346.xml",
                      "presigned_url": "https://s3.amazonaws.com/bucket/AEC_12346.xml?signature=..."
                    }
                  ],
                  "aec_results": [
                    {
                      "folio": 12345,
                      "sii_identifier": "AEC-2024-001234",
                      "sii_file_name": "AEC_12345.xml",
                      "status": "sent_to_sii"
                    },
                    {
                      "folio": 12346,
                      "sii_identifier": "AEC-2024-001235",
                      "sii_file_name": "AEC_12346.xml",
                      "status": "sent_to_sii"
                    }
                  ],
                  "errors": null,
                  "total_processed": 2,
                  "total_errors": 0,
                  "aec_sent": 2
                }
              }
            }
          },
          "400": {
            "description": "Error en los datos proporcionados",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "invalid_documents": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                },
                "examples": {
                  "missing_master_entity_id": {
                    "value": {
                      "error": "master_entity_id is required in the request body"
                    }
                  },
                  "missing_fields": {
                    "value": {
                      "error": "Missing required fields: assignee_rut, assignee_dv, assignee_email"
                    }
                  },
                  "invalid_documents": {
                    "value": {
                      "error": "Only electronic invoices (DTE 33) or exempt invoices (DTE 34) can be assigned",
                      "invalid_documents": [
                        {
                          "id": 858407,
                          "folio": 12347,
                          "dte_code": "39"
                        }
                      ]
                    }
                  },
                  "missing_credentials": {
                    "value": {
                      "error": "No se encontraron credenciales SII válidas para esta entidad. La cesión requiere una credencial SII personal."
                    },
                    "description": "Las cesiones se generan usando la contraseña del SII del representante legal, no con el certificado digital. Se requiere una credencial SII personal válida."
                  }
                }
              }
            }
          },
          "403": {
            "description": "No tienes acceso a esta entidad",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "No tienes acceso a esta entidad"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Documentos no encontrados",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Some documents were not found or don't belong to this entity"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "missing_folios": {
                      "type": "array",
                      "items": {
                        "type": "integer"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/webhooks": {
      "get": {
        "operationId": "listWebhooks",
        "tags": [
          "Webhooks"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Listar webhooks",
        "description": "Obtiene la lista de webhooks configurados para las entidades accesibles del usuario autenticado. Si se proporciona master_entity_id, filtra solo los webhooks de esa entidad.",
        "parameters": [
          {
            "name": "master_entity_id",
            "in": "query",
            "description": "ID de la entidad maestra para filtrar webhooks. Opcional. Si no se proporciona, retorna webhooks de todas las entidades accesibles del usuario autenticado.",
            "required": false,
            "schema": {
              "type": "integer"
            },
            "example": 123
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de webhooks obtenida exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Webhook"
                  }
                },
                "example": [
                  {
                    "id": 1,
                    "url": "https://mi-sistema.com/webhook",
                    "events": [
                      "document.issued",
                      "document.delivered"
                    ],
                    "events_display": [
                      "Emitido",
                      "Entregado"
                    ],
                    "secret": "mi-clave-secreta",
                    "is_active": true,
                    "last_status_code": 200,
                    "last_sent_at": "2025-01-13T10:30:00Z",
                    "success_rate": 95.5,
                    "last_delivery": {
                      "id": 123,
                      "event": "document.issued",
                      "is_success": true,
                      "status_code": 200,
                      "sent_at": "2025-01-13T10:30:00Z",
                      "document_id": 456
                    },
                    "created_at": "2025-01-01T09:00:00Z",
                    "updated_at": "2025-01-13T10:30:00Z"
                  }
                ]
              }
            }
          },
          "401": {
            "description": "Usuario no autenticado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Usuario sin acceso a entidades",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      },
      "post": {
        "operationId": "createWebhook",
        "tags": [
          "Webhooks"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "summary": "Crear webhook",
        "description": "Crea un nuevo webhook para una entidad específica del usuario autenticado.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookCreate"
              },
              "example": {
                "master_entity_id": 123,
                "url": "https://mi-sistema.com/webhook/callback",
                "events": [
                  "document.issued",
                  "document.delivered",
                  "document.rejected"
                ],
                "secret": "mi-clave-secreta-super-segura",
                "is_active": true
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Webhook creado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Webhook"
                },
                "example": {
                  "id": 1,
                  "url": "https://mi-sistema.com/webhook/callback",
                  "events": [
                    "document.issued",
                    "document.delivered",
                    "document.rejected"
                  ],
                  "events_display": [
                    "Emitido",
                    "Entregado",
                    "Rechazado SII"
                  ],
                  "secret": "mi-clave-secreta-super-segura",
                  "is_active": true,
                  "last_status_code": null,
                  "last_sent_at": null,
                  "success_rate": 0,
                  "last_delivery": null,
                  "created_at": "2025-01-13T11:00:00Z",
                  "updated_at": "2025-01-13T11:00:00Z"
                }
              }
            }
          },
          "400": {
            "description": "Datos inválidos",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "Usuario no autenticado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Usuario sin acceso a entidades",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/honorary/authorized-users/": {
      "get": {
        "summary": "Listar usuarios autorizados",
        "description": "Obtiene la lista de usuarios autorizados para emitir boletas de honorarios desde el SII. El master_entity_id se proporciona como query parameter.",
        "tags": [
          "Honorary"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "master_entity_id",
            "in": "query",
            "required": true,
            "schema": {
              "type": "integer",
              "description": "ID de la entidad maestra"
            },
            "description": "ID de la entidad para la cual se consultan los autorizados. Debe proporcionarse como query parameter."
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de usuarios autorizados obtenida exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "authorized_users": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "rut": {
                            "type": "string",
                            "description": "RUT del usuario con formato de puntos y guión",
                            "example": "12.345.678-9"
                          },
                          "nombre": {
                            "type": "string",
                            "description": "Nombre completo del usuario autorizado",
                            "example": "MARIA JOSEFA GONZALEZ LOPEZ"
                          },
                          "enrolled": {
                            "type": "boolean",
                            "description": "Si el usuario ya está enrolado en el sistema",
                            "example": false
                          }
                        },
                        "required": [
                          "rut",
                          "nombre",
                          "enrolled"
                        ]
                      }
                    }
                  },
                  "required": [
                    "authorized_users"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Parámetros inválidos",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Se requiere el parámetro master_entity_id"
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Sin permisos para acceder a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Usuario sin permisos para acceder a la entidad"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Entidad no encontrada o sin credenciales",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "No se encontró una credencial válida para la entidad"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Error al obtener usuarios autorizadores"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "patch": {
        "summary": "Enrolar usuario autorizado",
        "description": "Enrola un usuario autorizado del SII para emitir boletas de honorarios. El master_entity_id y rut se proporcionan en el body o query parameters. Para desenrolar, usa el endpoint de desenrolar.",
        "tags": [
          "Honorary"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "master_entity_id",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "description": "ID de la entidad emisora"
            },
            "description": "ID de la entidad emisora. Puede proporcionarse en query parameter o en el body."
          },
          {
            "name": "rut",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "description": "RUT del usuario autorizado"
            },
            "description": "RUT del usuario a gestionar. Puede proporcionarse en query parameter o en el body."
          }
        ],
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "master_entity_id": {
                    "type": "integer",
                    "description": "ID de la entidad emisora (requerido si no se proporciona en query parameter)",
                    "example": 1
                  },
                  "rut": {
                    "type": "string",
                    "description": "RUT del usuario autorizado (requerido si no se proporciona en query parameter)",
                    "example": "12.345.678-9"
                  },
                  "action": {
                    "type": "string",
                    "enum": [
                      "enroll",
                      "unenroll"
                    ],
                    "description": "Acción a realizar. Por defecto 'enroll'",
                    "default": "enroll",
                    "example": "enroll"
                  }
                },
                "required": [
                  "master_entity_id",
                  "rut"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Operación exitosa (enrolar o desenrolar)",
            "content": {
              "application/json": {
                "schema": {
                  "oneOf": [
                    {
                      "type": "object",
                      "description": "Respuesta al enrolar",
                      "properties": {
                        "status": {
                          "type": "string",
                          "enum": [
                            "enrolled",
                            "already_enrolled"
                          ],
                          "description": "Estado del enrolamiento"
                        },
                        "message": {
                          "type": "string",
                          "description": "Mensaje descriptivo"
                        },
                        "rut": {
                          "type": "string",
                          "description": "RUT normalizado del usuario enrolado"
                        },
                        "master_entity": {
                          "type": "object",
                          "description": "Información de la entidad creada/asociada",
                          "properties": {
                            "id": {
                              "type": "integer",
                              "description": "ID de la entidad"
                            },
                            "name": {
                              "type": "string",
                              "description": "Nombre completo de la entidad"
                            },
                            "tax_id": {
                              "type": "string",
                              "description": "RUT de la entidad"
                            }
                          }
                        }
                      },
                      "required": [
                        "status",
                        "message",
                        "rut"
                      ]
                    },
                    {
                      "type": "object",
                      "description": "Respuesta al desenrolar",
                      "properties": {
                        "success": {
                          "type": "boolean",
                          "description": "Siempre true para respuestas exitosas",
                          "example": true
                        },
                        "message": {
                          "type": "string",
                          "description": "Mensaje descriptivo del resultado",
                          "example": "Usuario autorizador 12345678-9 desenrolado exitosamente"
                        },
                        "rut": {
                          "type": "string",
                          "description": "RUT del usuario desenrolado",
                          "example": "12345678-9"
                        }
                      },
                      "required": [
                        "success",
                        "message",
                        "rut"
                      ]
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Datos inválidos, usuario no autorizado, o acción inválida",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "oneOf": [
                        {
                          "example": "Se requiere el parámetro master_entity_id"
                        },
                        {
                          "example": "Se requiere el parámetro rut"
                        },
                        {
                          "example": "El RUT proporcionado no está en la lista de usuarios autorizadores"
                        },
                        {
                          "example": "La acción debe ser 'enroll' o 'unenroll'"
                        },
                        {
                          "example": "El RUT proporcionado no es válido"
                        }
                      ]
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Sin permisos para acceder a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Usuario sin permisos para acceder a la entidad"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Entidad, credencial o usuario no encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "oneOf": [
                        {
                          "example": "No se encontró una credencial válida para la entidad"
                        },
                        {
                          "example": "No se encontró una entidad con el RUT asociada al usuario"
                        }
                      ]
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Error al gestionar usuario autorizador"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/honorary/master-entities/{master_entity_id}/authorized-users/": {
      "get": {
        "summary": "Listar usuarios autorizados",
        "description": "Obtiene la lista de usuarios autorizados para emitir boletas de honorarios desde el SII",
        "tags": [
          "Honorary"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "master_entity_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer",
              "description": "ID de la entidad maestra"
            },
            "description": "ID de la entidad para la cual se consultan los autorizados"
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de usuarios autorizados obtenida exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "authorized_users": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "rut": {
                            "type": "string",
                            "description": "RUT del usuario con formato de puntos y guión",
                            "example": "12.345.678-9"
                          },
                          "nombre": {
                            "type": "string",
                            "description": "Nombre completo del usuario autorizado",
                            "example": "MARIA JOSEFA GONZALEZ LOPEZ"
                          },
                          "enrolled": {
                            "type": "boolean",
                            "description": "Si el usuario ya está enrolado en el sistema",
                            "example": false
                          }
                        },
                        "required": [
                          "rut",
                          "nombre",
                          "enrolled"
                        ]
                      }
                    }
                  },
                  "required": [
                    "authorized_users"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Parámetros inválidos",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Se requiere el parámetro 'master_entity_id'"
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Sin permisos para acceder a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Usuario sin permisos para acceder a la entidad"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Entidad no encontrada o sin credenciales",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "No se encontró una credencial válida para la entidad"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Error al obtener usuarios autorizadores"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/honorary/master-entities/{master_entity_id}/authorized-users/{rut}/": {
      "patch": {
        "summary": "Enrolar usuario autorizado",
        "description": "Enrola un usuario autorizado del SII para emitir boletas de honorarios. Para desenrolar, usa el endpoint de desenrolar.",
        "tags": [
          "Honorary"
        ],
        "security": [
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "master_entity_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer",
              "description": "ID de la entidad emisora"
            },
            "description": "ID de la entidad emisora"
          },
          {
            "name": "rut",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "description": "RUT del usuario autorizado"
            },
            "description": "RUT del usuario a gestionar (con o sin formato)"
          }
        ],
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "action": {
                    "type": "string",
                    "enum": [
                      "enroll",
                      "unenroll"
                    ],
                    "description": "Acción a realizar. Por defecto 'enroll'",
                    "default": "enroll",
                    "example": "enroll"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Operación exitosa (enrolar o desenrolar)",
            "content": {
              "application/json": {
                "schema": {
                  "oneOf": [
                    {
                      "type": "object",
                      "description": "Respuesta al enrolar",
                      "properties": {
                        "status": {
                          "type": "string",
                          "enum": [
                            "enrolled",
                            "already_enrolled"
                          ],
                          "description": "Estado del enrolamiento"
                        },
                        "message": {
                          "type": "string",
                          "description": "Mensaje descriptivo"
                        },
                        "rut": {
                          "type": "string",
                          "description": "RUT normalizado del usuario enrolado"
                        },
                        "master_entity": {
                          "type": "object",
                          "description": "Información de la entidad creada/asociada",
                          "properties": {
                            "id": {
                              "type": "integer",
                              "description": "ID de la entidad"
                            },
                            "name": {
                              "type": "string",
                              "description": "Nombre completo de la entidad"
                            },
                            "tax_id": {
                              "type": "string",
                              "description": "RUT de la entidad"
                            }
                          }
                        }
                      },
                      "required": [
                        "status",
                        "message",
                        "rut"
                      ]
                    },
                    {
                      "type": "object",
                      "description": "Respuesta al desenrolar",
                      "properties": {
                        "success": {
                          "type": "boolean",
                          "description": "Siempre true para respuestas exitosas",
                          "example": true
                        },
                        "message": {
                          "type": "string",
                          "description": "Mensaje descriptivo del resultado",
                          "example": "Usuario autorizador 12345678-9 desenrolado exitosamente"
                        },
                        "rut": {
                          "type": "string",
                          "description": "RUT del usuario desenrolado",
                          "example": "12345678-9"
                        }
                      },
                      "required": [
                        "success",
                        "message",
                        "rut"
                      ]
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Datos inválidos, usuario no autorizado, o acción inválida",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "oneOf": [
                        {
                          "example": "El RUT proporcionado no está en la lista de usuarios autorizadores"
                        },
                        {
                          "example": "La acción debe ser 'enroll' o 'unenroll'"
                        },
                        {
                          "example": "El RUT proporcionado no es válido"
                        }
                      ]
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Sin permisos para acceder a la entidad",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Usuario sin permisos para acceder a la entidad"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Entidad, credencial o usuario no encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "oneOf": [
                        {
                          "example": "No se encontró una credencial válida para la entidad"
                        },
                        {
                          "example": "No se encontró una entidad con el RUT asociada al usuario"
                        }
                      ]
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Error al gestionar usuario autorizador"
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "apiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "Authorization",
        "description": "API Key para autenticación. Debe proporcionarse en el header Authorization con el formato: 'Api-Key YOUR-API-KEY' (incluye el prefijo 'Api-Key ' seguido de tu API key)"
      }
    },
    "schemas": {
      "DocumentStateRequest": {
        "type": "object",
        "required": [
          "event_code"
        ],
        "properties": {
          "event_code": {
            "type": "string",
            "enum": [
              "ERM",
              "ACD",
              "RCD",
              "RFT",
              "RFP"
            ],
            "description": "Código del evento a registrar:\n- ERM: Acuse de Recibo de Mercaderías y Servicios\n- ACD: Acepta Contenido del Documento\n- RCD: Reclama Contenido del Documento\n- RFT: Reclamo por Falta Total\n- RFP: Reclamo por Falta Parcial",
            "example": "ERM"
          },
          "rejection_reason": {
            "type": "string",
            "description": "Razón del rechazo (opcional, solo para eventos de rechazo: RCD, RFT, RFP)",
            "example": "Error en el monto facturado"
          }
        }
      },
      "DocumentStatesResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Indica si la operación fue exitosa",
            "example": true
          },
          "document_id": {
            "type": "integer",
            "description": "ID del documento",
            "example": 12345
          },
          "folio": {
            "type": "string",
            "description": "Folio del documento",
            "example": "123"
          },
          "states": {
            "type": "array",
            "description": "Lista de estados registrados para el documento, ordenados cronológicamente (más reciente primero)",
            "items": {
              "$ref": "#/components/schemas/DocumentState"
            }
          },
          "document": {
            "$ref": "#/components/schemas/DocumentDetail"
          }
        }
      },
      "DocumentState": {
        "type": "object",
        "properties": {
          "event_code": {
            "type": "string",
            "description": "Código del evento",
            "example": "ERM"
          },
          "event_description": {
            "type": "string",
            "description": "Descripción del evento",
            "example": "Acuse de Recibo"
          },
          "event_date": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha y hora del evento (ISO 8601)",
            "example": "2024-01-16T10:30:00Z"
          },
          "responsable_rut": {
            "type": "integer",
            "description": "RUT del responsable del evento",
            "example": 12345678
          },
          "responsable_dv": {
            "type": "string",
            "description": "Dígito verificador del RUT del responsable",
            "example": "9"
          },
          "rejected_by_user": {
            "type": "string",
            "format": "email",
            "nullable": true,
            "description": "Email del usuario que registró el rechazo (solo para eventos de rechazo)",
            "example": "usuario@ejemplo.com"
          },
          "accepted_by_user": {
            "type": "string",
            "format": "email",
            "nullable": true,
            "description": "Email del usuario que registró la aprobación (solo para eventos de aprobación)",
            "example": "usuario@ejemplo.com"
          }
        }
      },
      "DocumentStateResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Indica si la operación fue exitosa",
            "example": true
          },
          "event_registered": {
            "type": "boolean",
            "description": "Indica si el evento fue registrado exitosamente",
            "example": true
          },
          "message": {
            "type": "string",
            "description": "Mensaje descriptivo del resultado",
            "example": "Acuse de Recibo registrado. Este acuse rebajará el IVA del próximo mes."
          },
          "event_data": {
            "type": "object",
            "description": "Datos adicionales del evento registrado (proporcionados por el SII)",
            "additionalProperties": true
          },
          "document": {
            "$ref": "#/components/schemas/DocumentDetail"
          },
          "email_preview_data": {
            "type": "object",
            "description": "Datos para preview de email (solo para aprobaciones, rechazos o acuses de recibo)",
            "properties": {
              "should_open_modal": {
                "type": "boolean",
                "example": true
              },
              "document_id": {
                "type": "integer",
                "example": 12345
              },
              "action": {
                "type": "string",
                "enum": [
                  "accept",
                  "reject"
                ],
                "example": "accept"
              },
              "subject": {
                "type": "string",
                "example": "Acuse de Recibo - Factura 123"
              },
              "supplier_id": {
                "type": "integer",
                "example": 67890
              },
              "supplier_name": {
                "type": "string",
                "example": "Proveedor Ejemplo S.A."
              },
              "supplier_rut": {
                "type": "string",
                "example": "12345678-9"
              },
              "document_folio": {
                "type": "string",
                "example": "123"
              },
              "pdf_url": {
                "type": "string",
                "format": "uri",
                "nullable": true,
                "example": "https://api.tupana.ai/v1/documents/12345/pdf"
              },
              "rejection_reason": {
                "type": "string",
                "nullable": true,
                "example": "Error en el monto facturado"
              }
            }
          }
        }
      },
      "WebhookCreate": {
        "type": "object",
        "required": [
          "master_entity_id",
          "url",
          "events"
        ],
        "properties": {
          "master_entity_id": {
            "type": "integer",
            "description": "ID de la entidad maestra para la cual se crea el webhook",
            "example": 123
          },
          "url": {
            "type": "string",
            "format": "uri",
            "description": "URL del endpoint que recibirá las notificaciones"
          },
          "events": {
            "type": "array",
            "description": "Lista de eventos a notificar",
            "items": {
              "type": "string",
              "enum": [
                "document.issued",
                "document.delivered",
                "document.rejected",
                "document.paid",
                "document.cancelled"
              ]
            },
            "minItems": 1
          },
          "secret": {
            "type": "string",
            "description": "Clave secreta para verificar la autenticidad de las notificaciones",
            "maxLength": 255
          },
          "is_active": {
            "type": "boolean",
            "description": "Si el webhook está activo",
            "default": true
          }
        }
      },
      "Webhook": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "ID único del webhook"
          },
          "url": {
            "type": "string",
            "format": "uri",
            "description": "URL del endpoint que recibe las notificaciones"
          },
          "events": {
            "type": "array",
            "description": "Lista de eventos configurados",
            "items": {
              "type": "string",
              "enum": [
                "document.issued",
                "document.delivered",
                "document.rejected",
                "document.paid",
                "document.cancelled"
              ]
            }
          },
          "events_display": {
            "type": "array",
            "description": "Nombres legibles de los eventos",
            "items": {
              "type": "string"
            },
            "example": [
              "Emitido",
              "Entregado",
              "Rechazado SII"
            ]
          },
          "secret": {
            "type": "string",
            "description": "Clave secreta para verificar notificaciones",
            "nullable": true
          },
          "is_active": {
            "type": "boolean",
            "description": "Si el webhook está activo"
          },
          "last_status_code": {
            "type": "integer",
            "description": "Último código HTTP de respuesta",
            "nullable": true
          },
          "last_sent_at": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha de último envío",
            "nullable": true
          },
          "success_rate": {
            "type": "number",
            "format": "float",
            "description": "Tasa de éxito de entregas (0-100)",
            "minimum": 0,
            "maximum": 100
          },
          "last_delivery": {
            "type": "object",
            "description": "Información de la última entrega",
            "nullable": true,
            "properties": {
              "id": {
                "type": "integer",
                "description": "ID de la entrega"
              },
              "event": {
                "type": "string",
                "description": "Evento de la entrega"
              },
              "is_success": {
                "type": "boolean",
                "description": "Si la entrega fue exitosa"
              },
              "status_code": {
                "type": "integer",
                "description": "Código HTTP de respuesta"
              },
              "sent_at": {
                "type": "string",
                "format": "date-time",
                "description": "Fecha y hora del envío"
              },
              "document_id": {
                "type": "integer",
                "description": "ID del documento"
              }
            }
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha de creación"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha de última actualización"
          }
        }
      },
      "WebhookEvent": {
        "type": "object",
        "description": "Notificación enviada a la URL configurada del webhook",
        "properties": {
          "event": {
            "type": "string",
            "description": "Tipo de evento",
            "enum": [
              "document.issued",
              "document.delivered",
              "document.rejected",
              "document.paid",
              "document.cancelled"
            ]
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha y hora del evento"
          },
          "delivery_id": {
            "type": "string",
            "description": "ID único de la entrega"
          },
          "data": {
            "type": "object",
            "description": "Datos del documento",
            "properties": {
              "document_id": {
                "type": "integer",
                "description": "ID del documento"
              },
              "folio": {
                "type": "string",
                "description": "Folio del documento"
              },
              "document_type": {
                "type": "string",
                "description": "Tipo de documento (código DTE)"
              },
              "amount": {
                "type": "number",
                "format": "decimal",
                "description": "Monto total del documento"
              },
              "sender_rut": {
                "type": "string",
                "description": "RUT del emisor",
                "example": "use default"
              },
              "receiver_rut": {
                "type": "string",
                "description": "RUT del receptor",
                "example": "use default"
              },
              "issue_date": {
                "type": "string",
                "format": "date",
                "description": "Fecha de emisión"
              },
              "xml_file": {
                "type": "string",
                "format": "uri",
                "description": "URL del archivo XML (presigned)",
                "nullable": true
              },
              "pdf_file": {
                "type": "string",
                "format": "uri",
                "description": "URL del archivo PDF (presigned)",
                "nullable": true
              }
            }
          }
        }
      },
      "DocumentBatch": {
        "type": "object",
        "required": [
          "documents"
        ],
        "properties": {
          "documents": {
            "type": "array",
            "description": "Array de documentos a crear (máximo 200)",
            "items": {
              "$ref": "#/components/schemas/Document"
            }
          }
        }
      },
      "Document": {
        "type": "object",
        "required": [
          "dte_type",
          "document_issuer",
          "document_receiver",
          "details"
        ],
        "properties": {
          "date_issued": {
            "type": "string",
            "format": "date",
            "description": "Fecha de emisión (YYYY-MM-DD). Si X-Use-Defaults es true y no se proporciona, se usa la fecha actual."
          },
          "folio": {
            "type": "string",
            "description": "Folio del documento. Si X-Use-Defaults es true y no se proporciona, se genera automáticamente."
          },
          "dte_type": {
            "$ref": "#/components/schemas/DteType"
          },
          "document_issuer": {
            "$ref": "#/components/schemas/DocumentIssuer"
          },
          "document_receiver": {
            "$ref": "#/components/schemas/DocumentReceiver"
          },
          "details": {
            "type": "array",
            "minItems": 1,
            "items": {
              "$ref": "#/components/schemas/DetailItem"
            }
          },
          "header": {
            "$ref": "#/components/schemas/DocumentHeader"
          },
          "references": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ReferenceItem"
            }
          },
          "json_param": {
            "type": "object",
            "additionalProperties": true,
            "description": "JSON arbitrario almacenado textualmente"
          },
          "export_data": {
            "$ref": "#/components/schemas/ExportData"
          }
        }
      },
      "DteType": {
        "type": "object",
        "required": [
          "code"
        ],
        "properties": {
          "code": {
            "type": "string",
            "description": "Código del tipo de documento:\n- 33: Factura Electrónica\n- 34: Factura Exenta Electrónica\n- 39: Boleta Electrónica\n- 46: Factura de Compra Electrónica\n- 61: Nota de Crédito Electrónica\n- 80: Boleta de Honorarios Electrónica\n- 90: Boleta de Honorarios a Terceros Electrónica\n- 110: Factura de Exportación Electrónica",
            "enum": [
              "33",
              "34",
              "39",
              "46",
              "61",
              "80",
              "90",
              "110"
            ]
          }
        }
      },
      "DocumentHeader": {
        "type": "object",
        "properties": {
          "purchase_transaction_type": {
            "type": "string",
            "description": "Tipo de transacción de compra",
            "nullable": true
          },
          "sale_transaction_type": {
            "type": "string",
            "description": "Tipo de transacción de venta",
            "nullable": true
          },
          "payment_method": {
            "type": "string",
            "description": "Método de pago",
            "enum": [
              "1",
              "2",
              "3"
            ],
            "nullable": true
          },
          "due_date": {
            "type": "string",
            "format": "date",
            "description": "Fecha de vencimiento",
            "nullable": true
          },
          "vat_withheld": {
            "type": "boolean",
            "description": "Indica si el IVA está retenido. Solo aplicable para facturas de compra (DTE 46) y notas de crédito que referencian facturas de compra.",
            "example": false,
            "nullable": true
          },
          "retention_type": {
            "type": "string",
            "description": "Tipo de retención obligatorio para boletas de honorarios (DTE 80, 90). Define quién retiene el 14,5% legal.",
            "enum": [
              "RETRECEPTOR",
              "RETCONTRIBUYENTE"
            ],
            "example": "RETRECEPTOR",
            "nullable": true
          },
          "purchase_type": {
            "type": "string",
            "description": "Tipo de compra para facturas recibidas en el SII",
            "enum": [
              "1",
              "2",
              "3",
              "4",
              "5",
              "6",
              "7"
            ],
            "example": "1",
            "nullable": true
          }
        }
      },
      "DocumentIssuer": {
        "type": "object",
        "required": [
          "rut"
        ],
        "properties": {
          "rut": {
            "type": "string",
            "description": "RUT sin puntos y con guion, ej: 76543210-K. Si X-Use-Defaults es true, los demás campos se rellenarán automáticamente según la configuración.",
            "pattern": "^[0-9]{7,8}-[0-9K]$"
          },
          "business_name": {
            "type": "string",
            "description": "Razón social"
          },
          "phone_number": {
            "type": "string",
            "description": "Número de teléfono"
          },
          "email": {
            "type": "string",
            "description": "Correo electrónico"
          },
          "business_activity": {
            "type": "string",
            "description": "Giro comercial"
          },
          "activity_code": {
            "type": "integer",
            "description": "Código de actividad económica"
          },
          "sii_branch_code": {
            "type": "string",
            "description": "Código de sucursal SII"
          },
          "address": {
            "type": "string",
            "description": "Dirección"
          },
          "district": {
            "type": "string",
            "description": "Comuna"
          },
          "city": {
            "type": "string",
            "description": "Ciudad"
          }
        }
      },
      "DocumentReceiver": {
        "type": "object",
        "required": [
          "rut"
        ],
        "properties": {
          "rut": {
            "type": "string",
            "description": "RUT sin puntos y con guion, ej: 76543210-K. Si X-Use-Defaults es true, los demás campos se rellenarán automáticamente según la configuración.",
            "pattern": "^[0-9]{7,8}-[0-9K]$"
          },
          "business_name": {
            "type": "string",
            "description": "Razón social"
          },
          "contact": {
            "type": "string",
            "description": "Contacto"
          },
          "business_activity": {
            "type": "string",
            "description": "Giro comercial"
          },
          "address": {
            "type": "string",
            "description": "Dirección"
          },
          "district": {
            "type": "string",
            "description": "Comuna"
          },
          "city": {
            "type": "string",
            "description": "Ciudad"
          }
        }
      },
      "DetailItem": {
        "type": "object",
        "required": [
          "item_name",
          "quantity",
          "unit_price"
        ],
        "properties": {
          "item_name": {
            "type": "string",
            "description": "Nombre del ítem"
          },
          "quantity": {
            "type": "number",
            "description": "Cantidad"
          },
          "unit_price": {
            "type": "number",
            "format": "float",
            "description": "Precio unitario"
          },
          "item_description": {
            "type": "string",
            "description": "Descripción del ítem"
          },
          "discount_percent": {
            "type": "number",
            "format": "float",
            "description": "Porcentaje de descuento"
          },
          "item_total": {
            "type": "number",
            "format": "float",
            "description": "Total del ítem"
          },
          "item_code": {
            "type": "string",
            "description": "Código del ítem"
          },
          "unit": {
            "type": "string",
            "description": "Unidad de medida"
          },
          "other_tax": {
            "type": "number",
            "format": "float",
            "description": "Otros impuestos"
          },
          "item_type_code": {
            "type": "integer",
            "description": "Código de tipo de ítem"
          }
        }
      },
      "ReferenceItem": {
        "type": "object",
        "required": [
          "reference_folio",
          "reference_date",
          "dte_type_code"
        ],
        "properties": {
          "reference_folio": {
            "type": "integer",
            "description": "Folio de referencia"
          },
          "reference_date": {
            "type": "string",
            "format": "date",
            "description": "Fecha de referencia"
          },
          "reference_reason": {
            "type": "string",
            "description": "Razón de referencia. Para notas de crédito totales debe ser 'ANULA DOCUMENTO DE LA REFERENCIA'.",
            "example": "ANULA DOCUMENTO DE LA REFERENCIA"
          },
          "dte_type_code": {
            "type": "string",
            "description": "Código del tipo de DTE del documento referenciado"
          }
        }
      },
      "BatchResponse": {
        "type": "object",
        "properties": {
          "batch_id": {
            "type": "string",
            "format": "uuid",
            "description": "Identificador único del lote"
          },
          "status": {
            "type": "string",
            "description": "Estado del batch",
            "enum": [
              "created",
              "processing",
              "completed",
              "failed"
            ],
            "example": "processing"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha y hora de creación del batch"
          },
          "documents": {
            "type": "array",
            "description": "Array de documentos procesados en el batch",
            "items": {
              "type": "object",
              "properties": {
                "index": {
                  "type": "integer",
                  "description": "Índice del documento en el array original"
                },
                "status": {
                  "type": "string",
                  "enum": [
                    "created",
                    "processing",
                    "success",
                    "invalid",
                    "temporary_error",
                    "permanent_error",
                    "incomplete"
                  ],
                  "description": "Estado de procesamiento del documento"
                },
                "document": {
                  "type": "object",
                  "nullable": true,
                  "description": "Información completa del documento (solo presente si status permite tener documento)",
                  "properties": {
                    "id": {
                      "type": "integer",
                      "description": "ID único del documento creado"
                    },
                    "folio": {
                      "type": "string",
                      "nullable": true,
                      "description": "Número de folio del documento"
                    },
                    "date_issued": {
                      "type": "string",
                      "format": "date",
                      "description": "Fecha de emisión del documento"
                    },
                    "amount_with_iva": {
                      "type": "number",
                      "format": "float",
                      "description": "Monto total con IVA"
                    },
                    "receiver_id": {
                      "type": "integer",
                      "nullable": true,
                      "description": "ID de la entidad receptora"
                    },
                    "is_draft": {
                      "type": "boolean",
                      "description": "Indica si el documento es un borrador"
                    },
                    "can_be_issued": {
                      "type": "boolean",
                      "description": "Indica si el documento puede ser emitido"
                    },
                    "dte_type": {
                      "type": "object",
                      "properties": {
                        "code": {
                          "type": "string",
                          "description": "Código del tipo de DTE"
                        },
                        "description": {
                          "type": "string"
                        }
                      }
                    },
                    "sender": {
                      "type": "object",
                      "nullable": true,
                      "properties": {
                        "id": {
                          "type": "integer"
                        },
                        "name": {
                          "type": "string"
                        },
                        "tax_id": {
                          "type": "string"
                        }
                      }
                    },
                    "receiver": {
                      "type": "object",
                      "nullable": true,
                      "properties": {
                        "id": {
                          "type": "integer"
                        },
                        "name": {
                          "type": "string"
                        },
                        "tax_id": {
                          "type": "string"
                        }
                      }
                    },
                    "items": {
                      "type": "array",
                      "description": "Array de productos/servicios del documento",
                      "items": {
                        "type": "object",
                        "properties": {
                          "item_name": {
                            "type": "string"
                          },
                          "item_description": {
                            "type": "string",
                            "nullable": true
                          },
                          "quantity": {
                            "type": "number",
                            "nullable": true
                          },
                          "unit_price": {
                            "type": "number",
                            "nullable": true
                          },
                          "item_total": {
                            "type": "number",
                            "nullable": true
                          },
                          "unit": {
                            "type": "string",
                            "nullable": true
                          },
                          "item_code": {
                            "type": "string",
                            "nullable": true
                          },
                          "item_type_code": {
                            "type": "integer",
                            "nullable": true
                          },
                          "discount_percent": {
                            "type": "number",
                            "nullable": true
                          },
                          "other_tax": {
                            "type": "number",
                            "nullable": true
                          }
                        }
                      }
                    },
                    "document_total": {
                      "type": "object",
                      "nullable": true,
                      "properties": {
                        "net_amount": {
                          "type": "number",
                          "nullable": true
                        },
                        "iva_rate": {
                          "type": "number",
                          "nullable": true
                        },
                        "iva_amount": {
                          "type": "number",
                          "nullable": true
                        },
                        "total_amount": {
                          "type": "number",
                          "nullable": true
                        }
                      }
                    },
                    "pdf_url": {
                      "type": "string",
                      "format": "uri",
                      "nullable": true,
                      "description": "URL presignada al PDF del documento (válida por 2 horas)"
                    },
                    "pdf_download_url": {
                      "type": "string",
                      "nullable": true,
                      "description": "URL de descarga del PDF"
                    },
                    "retention_type": {
                      "type": "string",
                      "nullable": true,
                      "description": "Tipo de retención para boletas de honorarios (DTE 80, 90)",
                      "enum": [
                        "RETRECEPTOR",
                        "RETCONTRIBUYENTE"
                      ]
                    },
                    "export_data": {
                      "type": "object",
                      "nullable": true,
                      "description": "Datos de exportación para facturas internacionales (DTE 110, 111, 112)"
                    }
                  }
                },
                "errors": {
                  "type": "object",
                  "nullable": true,
                  "description": "Errores de validación si el estado es 'invalid' o hay errores"
                }
              }
            }
          }
        }
      },
      "DocumentListResponse": {
        "type": "object",
        "properties": {
          "count": {
            "type": "integer",
            "description": "Número total de documentos"
          },
          "next": {
            "type": "string",
            "nullable": true,
            "description": "URL de la siguiente página"
          },
          "previous": {
            "type": "string",
            "nullable": true,
            "description": "URL de la página anterior"
          },
          "results": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/DocumentDetail"
            }
          }
        }
      },
      "DocumentDetail": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "ID único del documento"
          },
          "folio": {
            "type": "string",
            "description": "Número de folio del documento",
            "nullable": true
          },
          "date_issued": {
            "type": "string",
            "format": "date",
            "description": "Fecha de emisión del documento"
          },
          "amount_with_iva": {
            "type": "number",
            "format": "float",
            "description": "Monto total con IVA"
          },
          "dte_type_code": {
            "type": "string",
            "description": "Código del tipo de DTE (ej: \"33\" para Factura Electrónica)"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha de creación del registro (ISO 8601)"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha de última actualización (ISO 8601)"
          }
        }
      },
      "DocumentDetailWithFiles": {
        "type": "object",
        "allOf": [
          {
            "$ref": "#/components/schemas/DocumentDetail"
          },
          {
            "type": "object",
            "properties": {
              "amount_iva": {
                "type": "number",
                "format": "float",
                "description": "Monto del IVA",
                "nullable": true
              },
              "amount_without_iva": {
                "type": "number",
                "format": "float",
                "description": "Monto sin IVA",
                "nullable": true
              },
              "currency": {
                "type": "string",
                "description": "Moneda del documento",
                "enum": [
                  "CLP",
                  "UF",
                  "USD",
                  "EUR"
                ],
                "example": "CLP"
              },
              "sender_id": {
                "type": "integer",
                "description": "ID de la entidad emisora"
              },
              "sender_name": {
                "type": "string",
                "description": "Nombre de la entidad emisora"
              },
              "sender_tax_id": {
                "type": "string",
                "description": "RUT de la entidad emisora"
              },
              "receiver_id": {
                "type": "string",
                "description": "ID de la entidad receptora (como string, puede ser null para algunos tipos de documentos)",
                "nullable": true
              },
              "receiver_name": {
                "type": "string",
                "description": "Nombre de la entidad receptora",
                "nullable": true
              },
              "receiver_tax_id": {
                "type": "string",
                "description": "RUT de la entidad receptora",
                "nullable": true
              },
              "has_credit_note": {
                "type": "boolean",
                "description": "Indica si el documento tiene una nota de crédito asociada"
              },
              "is_paid": {
                "type": "boolean",
                "description": "Indica si el documento está marcado como pagado"
              },
              "json_param": {
                "type": "object",
                "additionalProperties": true,
                "description": "Parámetros JSON almacenados del documento",
                "nullable": true
              },
              "traces": {
                "type": "array",
                "description": "Array de trazas de envío al SII",
                "items": {
                  "type": "object"
                }
              },
              "trace_update_log": {
                "type": "object",
                "description": "Log de actualización de trazas",
                "nullable": true
              },
              "document_states": {
                "type": "array",
                "description": "Array de estados del documento (rechazado, con NC, acuse, pagado, mérito ejecutivo)",
                "items": {
                  "type": "object",
                  "properties": {
                    "label": {
                      "type": "string",
                      "description": "Etiqueta del estado"
                    },
                    "description": {
                      "type": "string"
                    },
                    "state_type": {
                      "type": "string",
                      "description": "Tipo de estado del documento"
                    }
                  }
                }
              },
              "vat_withheld": {
                "type": "boolean",
                "description": "Indica si se retuvo IVA",
                "nullable": true
              },
              "exchange_rate": {
                "type": "string",
                "description": "Tipo de cambio para facturas internacionales",
                "nullable": true
              },
              "original_amount": {
                "type": "string",
                "description": "Monto original en moneda extranjera para facturas internacionales",
                "nullable": true
              },
              "state": {
                "type": "string",
                "description": "Estado del documento (draft, issued, etc.)",
                "nullable": true
              },
              "dte_type_description": {
                "type": "string",
                "description": "Descripción del tipo de DTE"
              },
              "pdf": {
                "type": "string",
                "format": "uri",
                "description": "URL presignada al PDF del documento (válida por tiempo limitado, generalmente 1 hora)",
                "nullable": true
              },
              "xml": {
                "type": "string",
                "description": "Contenido completo del XML del documento tributario electrónico",
                "nullable": true
              },
              "xml_error": {
                "type": "string",
                "description": "Mensaje de error si no se pudo obtener el XML (null si está disponible)",
                "nullable": true
              },
              "has_trace": {
                "type": "boolean",
                "description": "true si el documento tiene trazas de envío al SII, false en caso contrario"
              },
              "latest_trace_info": {
                "type": "object",
                "description": "Información de la última traza disponible (estado de envío, fecha, etc.)",
                "nullable": true,
                "properties": {
                  "status": {
                    "type": "string",
                    "description": "Estado de la traza",
                    "example": "accepted"
                  },
                  "timestamp": {
                    "type": "string",
                    "format": "date-time",
                    "description": "Fecha y hora de la traza",
                    "example": "2024-01-15T10:35:00Z"
                  },
                  "description": {
                    "type": "string",
                    "example": "Documento aceptado por el SII"
                  }
                }
              },
              "references": {
                "type": "array",
                "description": "Array de documentos referenciados (para notas de crédito, etc.)",
                "items": {
                  "$ref": "#/components/schemas/ReferenceItem"
                }
              },
              "details": {
                "type": "array",
                "description": "Array de productos/líneas del documento",
                "items": {
                  "$ref": "#/components/schemas/DetailItem"
                },
                "nullable": true
              },
              "header": {
                "$ref": "#/components/schemas/DocumentHeader",
                "description": "Información del encabezado del documento (transacción, pago, etc.)",
                "nullable": true
              },
              "document_issuer": {
                "$ref": "#/components/schemas/DocumentIssuer",
                "description": "Información completa del emisor del documento",
                "nullable": true
              },
              "document_receiver": {
                "$ref": "#/components/schemas/DocumentReceiver",
                "description": "Información completa del receptor del documento",
                "nullable": true
              }
            }
          }
        ]
      },
      "Error": {
        "required": [
          "error",
          "message"
        ],
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "description": "Código de error",
            "example": "VALIDATION_ERROR",
            "enum": [
              "VALIDATION_ERROR",
              "AUTHENTICATION_ERROR",
              "AUTHORIZATION_ERROR",
              "NOT_FOUND",
              "SII_ERROR",
              "INTERNAL_ERROR"
            ]
          },
          "message": {
            "type": "string",
            "description": "Mensaje de error"
          }
        }
      },
      "MasterEntity": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "ID único de la entidad maestra",
            "example": 371
          },
          "tax_id": {
            "type": "string",
            "description": "RUT de la entidad maestra",
            "example": "76.798.398-0"
          },
          "name": {
            "type": "string",
            "description": "Razón social de la entidad",
            "example": "SUPLO SPA"
          },
          "email": {
            "type": "string",
            "description": "Correo electrónico de contacto",
            "nullable": true,
            "example": null
          },
          "addresses": {
            "type": "array",
            "description": "Lista de direcciones de la entidad",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "integer",
                  "description": "ID único de la dirección",
                  "example": 6
                },
                "address": {
                  "type": "string",
                  "description": "Dirección completa",
                  "example": "AV TAJAMAR 183 OF 401   OFIC"
                },
                "district": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "integer",
                      "description": "ID único de la comuna",
                      "example": 7
                    },
                    "name": {
                      "type": "string",
                      "description": "Nombre de la comuna",
                      "example": "LAS CONDES"
                    },
                    "city": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "integer",
                          "description": "ID único de la ciudad",
                          "example": 3
                        },
                        "name": {
                          "type": "string",
                          "description": "Nombre de la ciudad",
                          "example": "SANTIAGO"
                        }
                      }
                    }
                  }
                },
                "sii_branch_code": {
                  "type": "string",
                  "description": "Código de sucursal SII",
                  "nullable": true,
                  "example": null
                },
                "phone": {
                  "type": "string",
                  "description": "Teléfono de la sucursal",
                  "nullable": true,
                  "example": null
                }
              }
            }
          },
          "activities": {
            "type": "array",
            "description": "Lista de actividades económicas de la entidad",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "integer",
                  "description": "ID único de la actividad",
                  "example": 1
                },
                "code": {
                  "type": "string",
                  "description": "Código de actividad económica",
                  "example": "620900"
                },
                "name": {
                  "type": "string",
                  "description": "Nombre de la actividad económica",
                  "example": "OTRAS ACTIVIDADES DE TECNOLOGIA DE LA IN"
                }
              }
            }
          }
        }
      },
      "ScheduledDocumentReferenceItem": {
        "type": "object",
        "description": "Referencia a un documento (ej. para notas de crédito). Máximo 3 referencias por documento programado.",
        "properties": {
          "id": {
            "type": "integer",
            "description": "ID de la referencia (solo en respuesta)",
            "example": 1
          },
          "dte_type_code": {
            "type": "string",
            "description": "Código del tipo de DTE del documento referenciado (ej: 33, 61)",
            "example": "33"
          },
          "reference_folio": {
            "type": "string",
            "description": "Folio del documento referenciado",
            "example": "123"
          },
          "reference_date": {
            "type": "string",
            "format": "date",
            "description": "Fecha del documento referenciado (YYYY-MM-DD)",
            "example": "2024-01-15"
          },
          "reference_reason": {
            "type": "string",
            "description": "Razón de la referencia. Para notas de crédito totales: 'ANULA DOCUMENTO DE LA REFERENCIA'.",
            "nullable": true,
            "example": "ANULA DOCUMENTO DE LA REFERENCIA"
          }
        }
      },
      "ScheduledDocumentListResponse": {
        "type": "object",
        "properties": {
          "count": {
            "type": "integer",
            "description": "Total de documentos programados",
            "example": 25
          },
          "next": {
            "type": "string",
            "nullable": true,
            "description": "URL de la siguiente página",
            "example": "https://api.tupana.ai/v1/scheduled-documents?master_entity_id=123&page=2"
          },
          "previous": {
            "type": "string",
            "nullable": true,
            "description": "URL de la página anterior",
            "example": null
          },
          "results": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ScheduledDocument"
            }
          }
        }
      },
      "ScheduledDocument": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "ID único del documento programado",
            "example": 789
          },
          "sender": {
            "type": "object",
            "description": "Información de la entidad emisora",
            "properties": {
              "id": {
                "type": "integer",
                "example": 123
              },
              "name": {
                "type": "string",
                "example": "Empresa Ejemplo SpA"
              },
              "rut": {
                "type": "string",
                "example": "76543210-1"
              }
            }
          },
          "receiver": {
            "type": "object",
            "nullable": true,
            "description": "Información de la entidad receptora",
            "properties": {
              "id": {
                "type": "integer",
                "example": 456
              },
              "name": {
                "type": "string",
                "example": "Cliente ABC Ltda"
              },
              "rut": {
                "type": "string",
                "example": "12345678-9"
              }
            }
          },
          "dte_type": {
            "type": "object",
            "description": "Tipo de documento tributario",
            "properties": {
              "id": {
                "type": "integer",
                "example": 1
              },
              "code": {
                "type": "string",
                "example": "33"
              },
              "description": {
                "type": "string",
                "example": "Factura Electrónica"
              }
            }
          },
          "frequency": {
            "type": "string",
            "enum": [
              "daily",
              "weekly",
              "monthly",
              "quarterly",
              "semiannual",
              "yearly"
            ],
            "description": "Frecuencia de ejecución",
            "example": "monthly"
          },
          "frequency_display": {
            "type": "string",
            "description": "Frecuencia en formato legible",
            "example": "Mensual"
          },
          "day_of_month": {
            "type": "integer",
            "nullable": true,
            "description": "Día del mes en que se ejecutará el documento (1-31). Requerido para frecuencias: monthly, quarterly, semiannual, yearly. Si el día no existe en un mes (ej: 31 en febrero), se usará el último día del mes.",
            "example": 15
          },
          "day_of_week": {
            "type": "integer",
            "nullable": true,
            "description": "Día de la semana para ejecución (1=Lunes, 7=Domingo)",
            "example": null
          },
          "next_execution": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha y hora de la próxima ejecución",
            "example": "2024-02-15T10:00:00Z"
          },
          "status": {
            "type": "string",
            "enum": [
              "active",
              "inactive",
              "completed"
            ],
            "description": "Estado del documento programado",
            "example": "active"
          },
          "status_display": {
            "type": "string",
            "description": "Estado en formato legible",
            "example": "Activo"
          },
          "amount": {
            "type": "number",
            "description": "Monto del documento",
            "example": 100000
          },
          "currency": {
            "type": "string",
            "enum": [
              "CLP",
              "UF",
              "USD",
              "EUR"
            ],
            "description": "Moneda del documento",
            "example": "CLP"
          },
          "currency_day": {
            "type": "integer",
            "nullable": true,
            "minimum": 1,
            "maximum": 31,
            "description": "Día del mes (1-31) para tomar el valor del tipo de cambio. Aplica cuando la moneda es UF o USD; si no se indica, se usa el día de emisión.",
            "example": 10
          },
          "completed_occurrences": {
            "type": "integer",
            "description": "Número de veces que se ha ejecutado",
            "example": 5
          },
          "max_occurrences": {
            "type": "integer",
            "nullable": true,
            "description": "Número máximo de ejecuciones",
            "example": null
          },
          "start_date": {
            "type": "string",
            "format": "date",
            "nullable": true,
            "description": "Fecha de inicio de la programación (YYYY-MM-DD). Define desde cuándo comenzará a ejecutarse el documento programado. Si no se proporciona, se usa la fecha actual. La primera ejecución será calculada a partir de esta fecha según la frecuencia configurada.",
            "example": "2024-02-01"
          },
          "emission_day_adjustment": {
            "type": "string",
            "enum": [
              "none",
              "next",
              "previous"
            ],
            "description": "Ajuste de fecha de emisión a días hábiles: 'none' (sin ajuste), 'next' (próximo día hábil), 'previous' (anterior día hábil)",
            "default": "none",
            "example": "none"
          },
          "end_type": {
            "type": "string",
            "enum": [
              "never",
              "on_date",
              "after_occurrences"
            ],
            "description": "Tipo de finalización de la programación: 'never' (nunca finaliza, se ejecuta indefinidamente), 'on_date' (finaliza en una fecha específica, requiere end_date), 'after_occurrences' (finaliza después de un número máximo de ejecuciones, requiere max_occurrences). Por defecto: 'never'.",
            "default": "never",
            "example": "never"
          },
          "end_date": {
            "type": "string",
            "format": "date",
            "nullable": true,
            "description": "Fecha de finalización de la programación (YYYY-MM-DD). Solo aplica y es requerido si end_type es 'on_date'. El documento programado dejará de ejecutarse después de esta fecha.",
            "example": "2024-12-31"
          },
          "details": {
            "type": "array",
            "description": "Detalles/productos del documento",
            "items": {
              "$ref": "#/components/schemas/ScheduledDocumentDetail"
            }
          },
          "references": {
            "type": "array",
            "maxItems": 3,
            "description": "Referencias a documentos (ej. factura anulada por nota de crédito). Máximo 3 referencias.",
            "items": {
              "$ref": "#/components/schemas/ScheduledDocumentReferenceItem"
            }
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha de creación",
            "example": "2024-01-15T10:00:00Z"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "description": "Fecha de última actualización",
            "example": "2024-01-20T15:30:00Z"
          }
        }
      },
      "ScheduledDocumentCreate": {
        "type": "object",
        "required": [
          "sender",
          "dte_type",
          "frequency",
          "details",
          "receiver_tax_id"
        ],
        "properties": {
          "sender": {
            "type": "integer",
            "description": "ID de la entidad maestra emisora (obligatorio)",
            "example": 123
          },
          "dte_type": {
            "type": "string",
            "description": "Código del tipo de DTE (ej: '33' para Factura Electrónica)",
            "example": "33"
          },
          "receiver_tax_id": {
            "type": "string",
            "description": "RUT del receptor (formato: 12345678-9). El sistema buscará un cliente existente con este RUT. Si no existe, creará uno nuevo automáticamente. Campo requerido.",
            "example": "12345678-9"
          },
          "frequency": {
            "type": "string",
            "enum": [
              "daily",
              "weekly",
              "monthly",
              "quarterly",
              "semiannual",
              "yearly"
            ],
            "description": "Frecuencia de ejecución del documento programado. Valores: 'daily' (diario), 'weekly' (semanal), 'monthly' (mensual), 'quarterly' (trimestral), 'semiannual' (semestral), 'yearly' (anual).",
            "example": "monthly"
          },
          "day_of_month": {
            "type": "integer",
            "description": "Día del mes en que se ejecutará el documento (1-31). Requerido para frecuencias: monthly, quarterly, semiannual, yearly. Si el día no existe en un mes (ej: 31 en febrero), se usará el último día del mes.",
            "minimum": 1,
            "maximum": 31,
            "example": 15
          },
          "day_of_week": {
            "type": "integer",
            "description": "Día de la semana en que se ejecutará el documento (1=Lunes, 2=Martes, 3=Miércoles, 4=Jueves, 5=Viernes, 6=Sábado, 7=Domingo). Requerido para frecuencia semanal (weekly).",
            "minimum": 1,
            "maximum": 7,
            "example": 1
          },
          "start_date": {
            "type": "string",
            "format": "date",
            "description": "Fecha de inicio de la programación (YYYY-MM-DD). Define desde cuándo comenzará a ejecutarse el documento programado. Si no se proporciona, se usa la fecha actual. La primera ejecución será calculada a partir de esta fecha según la frecuencia configurada.",
            "example": "2024-02-01"
          },
          "emission_day_adjustment": {
            "type": "string",
            "enum": [
              "none",
              "next",
              "previous"
            ],
            "description": "Ajuste de fecha de emisión a días hábiles. Si la fecha calculada cae en fin de semana o feriado, se ajusta según esta opción: 'none' (sin ajuste, emite en la fecha calculada aunque sea fin de semana), 'next' (ajusta al próximo día hábil), 'previous' (ajusta al anterior día hábil). Por defecto: 'none'.",
            "default": "none",
            "example": "none"
          },
          "end_type": {
            "type": "string",
            "enum": [
              "never",
              "on_date",
              "after_occurrences"
            ],
            "description": "Tipo de finalización de la programación: 'never' (nunca finaliza, se ejecuta indefinidamente), 'on_date' (finaliza en una fecha específica, requiere end_date), 'after_occurrences' (finaliza después de un número máximo de ejecuciones, requiere max_occurrences). Por defecto: 'never'.",
            "default": "never",
            "example": "never"
          },
          "end_date": {
            "type": "string",
            "format": "date",
            "description": "Fecha de finalización de la programación (YYYY-MM-DD). Solo aplica y es requerido si end_type es 'on_date'. El documento programado dejará de ejecutarse después de esta fecha.",
            "example": "2024-12-31"
          },
          "currency": {
            "type": "string",
            "description": "Moneda del documento",
            "enum": [
              "CLP",
              "UF",
              "USD",
              "EUR"
            ],
            "default": "CLP",
            "example": "CLP"
          },
          "currency_day": {
            "type": "integer",
            "nullable": true,
            "minimum": 1,
            "maximum": 31,
            "description": "Día del mes (1-31) para tomar el valor del tipo de cambio (UF o USD). Si no se indica, se usa el día de emisión.",
            "example": 10
          },
          "references": {
            "type": "array",
            "maxItems": 3,
            "description": "Referencias a documentos (ej. factura anulada por nota de crédito). Máximo 3 referencias.",
            "items": {
              "$ref": "#/components/schemas/ScheduledDocumentReferenceItem"
            }
          },
          "status": {
            "type": "string",
            "enum": [
              "active",
              "inactive"
            ],
            "description": "Estado inicial del documento programado",
            "default": "active",
            "example": "active"
          },
          "max_occurrences": {
            "type": "integer",
            "description": "Número máximo de ejecuciones (opcional, null = infinito). Solo aplica si end_type es 'after_occurrences'.",
            "minimum": 1,
            "example": 12
          },
          "details": {
            "type": "array",
            "description": "Detalles/productos del documento",
            "minItems": 1,
            "items": {
              "$ref": "#/components/schemas/ScheduledDocumentDetailCreate"
            }
          }
        }
      },
      "ScheduledDocumentUpdate": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "active",
              "inactive"
            ],
            "description": "Estado del documento programado",
            "example": "inactive"
          },
          "amount": {
            "type": "number",
            "description": "Monto total del documento",
            "minimum": 0,
            "example": 120000
          },
          "frequency": {
            "type": "string",
            "enum": [
              "daily",
              "weekly",
              "monthly",
              "quarterly",
              "semiannual",
              "yearly"
            ],
            "description": "Frecuencia de ejecución del documento programado. Valores: 'daily' (diario), 'weekly' (semanal), 'monthly' (mensual), 'quarterly' (trimestral), 'semiannual' (semestral), 'yearly' (anual).",
            "example": "weekly"
          },
          "day_of_month": {
            "type": "integer",
            "description": "Día del mes en que se ejecutará el documento (1-31). Requerido para frecuencias: monthly, quarterly, semiannual, yearly. Si el día no existe en un mes (ej: 31 en febrero), se usará el último día del mes.",
            "minimum": 1,
            "maximum": 31,
            "example": 20
          },
          "day_of_week": {
            "type": "integer",
            "description": "Día de la semana en que se ejecutará el documento (1=Lunes, 2=Martes, 3=Miércoles, 4=Jueves, 5=Viernes, 6=Sábado, 7=Domingo). Requerido para frecuencia semanal (weekly).",
            "minimum": 1,
            "maximum": 7,
            "example": 2
          },
          "start_date": {
            "type": "string",
            "format": "date",
            "description": "Fecha de inicio de la programación (YYYY-MM-DD). Define desde cuándo comenzará a ejecutarse el documento programado. La primera ejecución será calculada a partir de esta fecha según la frecuencia configurada.",
            "example": "2024-02-01"
          },
          "emission_day_adjustment": {
            "type": "string",
            "enum": [
              "none",
              "next",
              "previous"
            ],
            "description": "Ajuste de fecha de emisión a días hábiles. Si la fecha calculada cae en fin de semana o feriado, se ajusta según esta opción: 'none' (sin ajuste, emite en la fecha calculada aunque sea fin de semana), 'next' (ajusta al próximo día hábil), 'previous' (ajusta al anterior día hábil).",
            "example": "none"
          },
          "end_type": {
            "type": "string",
            "enum": [
              "never",
              "on_date",
              "after_occurrences"
            ],
            "description": "Tipo de finalización de la programación: 'never' (nunca finaliza, se ejecuta indefinidamente), 'on_date' (finaliza en una fecha específica, requiere end_date), 'after_occurrences' (finaliza después de un número máximo de ejecuciones, requiere max_occurrences).",
            "example": "never"
          },
          "end_date": {
            "type": "string",
            "format": "date",
            "description": "Fecha de finalización de la programación (YYYY-MM-DD). Solo aplica y es requerido si end_type es 'on_date'. El documento programado dejará de ejecutarse después de esta fecha.",
            "example": "2024-12-31"
          },
          "max_occurrences": {
            "type": "integer",
            "nullable": true,
            "description": "Número máximo de ejecuciones. Solo aplica y es requerido si end_type es 'after_occurrences'. El documento programado dejará de ejecutarse después de alcanzar este número de ejecuciones.",
            "minimum": 1,
            "example": 24
          },
          "currency_day": {
            "type": "integer",
            "nullable": true,
            "minimum": 1,
            "maximum": 31,
            "description": "Día del mes (1-31) para tomar el valor del tipo de cambio (UF o USD). Si no se indica, se usa el día de emisión.",
            "example": 10
          },
          "references": {
            "type": "array",
            "maxItems": 3,
            "description": "Referencias a documentos (ej. factura anulada por nota de crédito). Máximo 3 referencias. Si se envía, reemplaza todas las referencias existentes.",
            "items": {
              "$ref": "#/components/schemas/ScheduledDocumentReferenceItem"
            }
          },
          "details": {
            "type": "array",
            "description": "Detalles/productos del documento. Si se envía, reemplaza todos los detalles existentes. Misma estructura que en creación.",
            "items": {
              "$ref": "#/components/schemas/ScheduledDocumentDetailCreate"
            }
          }
        }
      },
      "ScheduledDocumentDetail": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "ID único del detalle",
            "example": 1
          },
          "item_name": {
            "type": "string",
            "description": "Nombre del producto o servicio",
            "example": "Servicio mensual de consultoría"
          },
          "item_description": {
            "type": "string",
            "description": "Descripción del producto o servicio",
            "example": "Consultoría especializada en tecnología"
          },
          "quantity": {
            "type": "number",
            "description": "Cantidad",
            "example": 1
          },
          "unit_price": {
            "type": "number",
            "description": "Precio unitario",
            "example": 100000
          },
          "item_total": {
            "type": "number",
            "description": "Total de la línea (calculado automáticamente)",
            "example": 100000
          },
          "unit_of_measurement": {
            "type": "string",
            "description": "Unidad de medida",
            "example": "UN"
          },
          "item_code": {
            "type": "string",
            "description": "Código del producto o servicio según el sistema del emisor. Este código aparece en el documento emitido y puede ser usado para identificación interna del producto.",
            "nullable": true,
            "example": "PROD-001"
          },
          "item_type_code": {
            "type": "string",
            "description": "Código de tipo de ítem según clasificación SII. Identifica la categoría del producto o servicio (ej: '1' para productos, '2' para servicios).",
            "nullable": true,
            "example": "1"
          }
        }
      },
      "ExportData": {
        "type": "object",
        "description": "Datos específicos para facturas de exportación (DTE 110) y notas de crédito de exportación (DTE 112). Solo requerido cuando se selecciona uno de estos tipos de documento.",
        "properties": {
          "tax_id_receptor": {
            "type": "string",
            "description": "Identificación tributaria del receptor en el país de destino"
          },
          "destination_country_code": {
            "type": "string",
            "description": "Código del país de destino (ISO 3166-1 alpha-2)",
            "example": "US"
          },
          "currency_code": {
            "type": "string",
            "description": "Código de la moneda (ISO 4217)",
            "example": "USD"
          },
          "exchange_rate": {
            "type": "string",
            "description": "Tipo de cambio aplicado",
            "example": "800.50"
          },
          "departure_port_code": {
            "type": "string",
            "description": "Código del puerto de embarque"
          },
          "arrival_port_code": {
            "type": "string",
            "description": "Código del puerto de desembarque"
          },
          "departure_port_name": {
            "type": "string",
            "description": "Nombre del puerto de embarque"
          },
          "arrival_port_name": {
            "type": "string",
            "description": "Nombre del puerto de desembarque"
          },
          "total_packages": {
            "type": "string",
            "description": "Número total de bultos"
          },
          "sale_mode_code": {
            "type": "string",
            "description": "Código de modalidad de venta"
          },
          "export_type": {
            "type": "string",
            "description": "Tipo de exportación",
            "default": "0"
          }
        }
      },
      "ScheduledDocumentDetailCreate": {
        "type": "object",
        "required": [
          "item_name",
          "quantity",
          "unit_price"
        ],
        "properties": {
          "item_name": {
            "type": "string",
            "description": "Nombre del producto o servicio",
            "example": "Servicio mensual de consultoría"
          },
          "item_description": {
            "type": "string",
            "description": "Descripción del producto o servicio (opcional)",
            "example": "Consultoría especializada en tecnología"
          },
          "quantity": {
            "type": "number",
            "description": "Cantidad",
            "minimum": 0.01,
            "example": 1
          },
          "unit_price": {
            "type": "number",
            "description": "Precio unitario",
            "minimum": 0,
            "example": 100000
          },
          "unit": {
            "type": "string",
            "description": "Unidad de medida (opcional). Para UF/USD se asigna automáticamente.",
            "example": "UN"
          },
          "item_code": {
            "type": "string",
            "description": "Código del ítem",
            "nullable": true,
            "example": "PROD-001"
          },
          "item_type_code": {
            "type": "string",
            "description": "Código de tipo de ítem",
            "nullable": true,
            "example": "1"
          }
        }
      }
    }
  }
}