---
title: "Gestionar Usuario Autorizado"
openapi: "PATCH /honorary/master-entities/{master_entity_id}/authorized-users/{rut}/"
---

## Qué hace

Gestiona usuarios autorizados del SII para emitir boletas de honorarios. Puede **enrolar** o **desenrolar** un usuario según el parámetro `action` en el body.

### Enrolar (action="enroll" o sin action)

Enrola un usuario autorizado del SII para que pueda emitir boletas de honorarios desde la cuenta del usuario para una entidad emisora específica. Al enrolar:

1. Valida que el RUT esté en la lista de autorizados del SII para la entidad
2. Extrae el nombre real del usuario desde el SII
3. Crea una nueva entidad con la razón social completa
4. Asocia la entidad al usuario y a la credencial de la entidad emisora

## Ejemplos de uso

- Permitir que un contador emita boletas de honorarios para una empresa específica
- Agregar un nuevo autorizador al sistema después de verificar sus permisos en el SII
- Configurar usuarios para emisión de boletas en una entidad emisora específica

## Reglas de negocio

### Acción por defecto
Si no se especifica el parámetro `action` en el body, el sistema asume que se quiere enrolar el usuario. Para desenrolar, se debe especificar explícitamente `action="unenroll"`.

### Validación automática
El RUT debe existir en la lista de autorizados del SII. Si el RUT no está autorizado, la operación falla. Esto garantiza que solo se puedan enrolar usuarios que realmente tienen permisos en el SII.

### Creación de entidad automática
Si el usuario no tiene una entidad asociada, se crea automáticamente. El nombre de la entidad se obtiene del registro del SII para garantizar exactitud. La entidad se asocia tanto al usuario como a la credencial de la entidad emisora.

### Usuario ya enrolado
Si el usuario ya está enrolado, la operación retorna un estado especial indicando que ya estaba enrolado, pero no falla. Esto permite que el frontend muestre el estado correcto sin generar errores.

### Actualización del contexto
Después del enrolamiento exitoso, el frontend debe actualizar el contexto de entidades. La nueva entidad aparecerá en el selector de empresas con su nombre real obtenido del SII.

## Consideraciones importantes

- Requiere credenciales SII válidas para validar la autorización
- El nombre se obtiene directamente del SII para garantizar exactitud
- Una vez enrolado, el usuario puede emitir boletas desde esa cuenta
- El enrolamiento es reversible mediante el endpoint de desenrolar